<script>
 const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxaGBM2UyvLY0cFXJkzYpFsJpXi2uGuzhFi7n6N5SwWrLkxWFWbYKkOe7lDPIQzyoTf0A/exec';
  // ENVOI (POST) vers la feuille cible
  function sendToHub(payload, ChangementQuart, RapportFinRotationSuperviseur, ChangementRotationsuperviseur, Changementquartcontrole, ChangementRotationControl, Gestionquarts, adminchangementquart ) {
    const body = Object.assign({_sheet: ChangementQuart, RapportFinRotationSuperviseur, ChangementRotationsuperviseur, Changementquartcontrole, ChangementRotationControl, Gestionquarts, adminchangementquart }, payload);
    return fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    }).then(r => r.json());
  }

  // LECTURE (GET) d’une feuille précise
  function fetchFromHub(ChangementQuart, RapportFinRotationSuperviseur, ChangementRotationsuperviseur, Changementquartcontrole, ChangementRotationControl, Gestionquarts, adminchangementquart ) {
    return fetch(`${ENDPOINT}?sheet=${encodeURIComponent(ChangementQuart, RapportFinRotationSuperviseur, ChangementRotationsuperviseur, Changementquartcontrole, ChangementRotationControl, Gestionquarts, adminchangementquart )}`)
      .then(r => r.json());
  }
</script>
<!DOCTYPE html>
<!--
  Page de consultation des rapports multi-types.
  Cette version améliore la page de recherche existante en ajoutant un filtrage
  par type de rapport (changement de quart pour superviseur ou salle de contrôle,
  et changement de rotation pour superviseur ou salle de contrôle). Chaque type
  est stocké dans une clé distincte de localStorage : `rapports` pour les
  changements de quart des superviseurs, `rapportsControl` pour les changements
  de quart de la salle de contrôle, `rotationsSuperviseur` pour les rotations
  des superviseurs et `rotationsControl` pour les rotations de la salle de
  contrôle. L’utilisateur peut sélectionner le type de rapport à consulter
  puis filtrer par date et texte libre. Les résultats sont affichés dans un
  tableau.
-->
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Recherche de rapports multi-types</title>
  <style>
    :root {
      --primary-color: #253746;
      --secondary-color: #324e67;
      --accent-color: #0078C8;
      --text-light: #ffffff;
      --field-bg: #f5f5f5;
    }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: var(--primary-color); color: var(--text-light); }
    .wrapper { max-width: 1000px; margin: 2rem auto; background: var(--secondary-color); border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); overflow: hidden; }
    .header { background: var(--primary-color); padding: 1rem 2rem; display: flex; align-items: center; border-bottom: 3px solid var(--accent-color); }
    .header img { height: 50px; margin-right: 1rem; }
    .header h1 { font-size: 1.5rem; margin: 0; color: var(--text-light); }
    .nav-buttons { display: flex; justify-content: center; gap: 1rem; margin: 1rem; }
    .nav-button { display: inline-block; padding: 0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border-radius: 4px; text-decoration: none; font-size: 1rem; }
    .nav-button:hover { background: #005fa0; }
    .content { padding: 2rem; }
    /* Répartition des filtres en quatre colonnes fixes pour plus de clarté */
    form { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
    input[type="date"], select, input[type="text"] { width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 4px; background: var(--field-bg); color: #333; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.6rem; text-align: left; }
    th { background: var(--accent-color); color: var(--text-light); }
    .no-results { text-align: center; padding: 1rem; }

    /* Masquer la barre de navigation et le formulaire lors de l'impression pour ne conserver que les résultats */
    @media print {
      .nav-buttons, form { display: none; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <img src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" alt="Logo AEM">
      <h1>Recherche de rapports</h1>
    </div>
    <div class="nav-buttons">
      <a href="index.html" class="nav-button">Retour à l'accueil</a>
      <!-- Bouton pour imprimer les résultats de la recherche -->
      <button id="printResults" type="button" class="nav-button" style="border:none; cursor:pointer;">Imprimer les résultats</button>
    </div>
    <div class="content">
      <form id="searchForm">
        <!-- Première ligne : type et date de début -->
        <div>
          <label for="reportType">Type de rapport&nbsp;:</label>
          <!-- Ajout d'une option vide en première position : si aucun type n'est sélectionné, la page affiche le dernier rapport sauvegardé -->
          <select id="reportType" name="reportType">
            <option value="">--Tous les types--</option>
            <option value="quart_superviseur">Changement de quart (opération)</option>
            <option value="quart_control">Changement de quart (salle de contrôle)</option>
            <option value="rotation_superviseur">Changement de rotation (superviseur)</option>
            <option value="rotation_control">Changement de rotation (salle de contrôle)</option>
          </select>
        </div>
        <div>
          <label for="date_debut">Date début&nbsp;:</label>
          <input type="date" id="date_debut" name="date_debut">
        </div>
        <!-- Deuxième ligne : superviseur et chef d'équipe -->
        <div>
          <label for="superviseur_sel">Superviseur&nbsp;:</label>
          <select id="superviseur_sel" name="superviseur_sel">
            <option value="">--Tous--</option>
          </select>
        </div>
        <div>
          <label for="chef_sel">Chef d'équipe&nbsp;:</label>
          <select id="chef_sel" name="chef_sel">
            <option value="">--Tous--</option>
          </select>
        </div>
        <!-- Troisième ligne : quart/rotation et secteur -->
        <div>
          <label for="quart_sel">Quart / Rotation&nbsp;:</label>
          <select id="quart_sel" name="quart_sel">
            <option value="">--Tous--</option>
            <option value="Jour">Jour</option>
            <option value="Nuit">Nuit</option>
          </select>
        </div>
        <div>
          <label for="secteur_sel">Secteur&nbsp;:</label>
          <select id="secteur_sel" name="secteur_sel">
            <option value="">--Tous--</option>
            <option value="Digestion">Digestion</option>
            <option value="Cristalisation">Cristalisation</option>
            <option value="Centrifuge">Centrifuge</option>
            <option value="Décomposition (Harpers)">Décomposition (Harpers)</option>
            <option value="Calcination (F04)">Calcination (F04)</option>
            <option value="Lavage S02">Lavage S02</option>
            <option value="Buhler">Buhler</option>
            <option value="HP60 (Mega Pulse)">HP60 (Mega Pulse)</option>
            <option value="Mini-Pulse">Mini-Pulse</option>
            <option value="Fabrication de Puck">Fabrication de Puck</option>
            <option value="Traitement des eaux">Traitement des eaux</option>
            <option value="Commentaire générale">Commentaire générale</option>
            <option value="Modifications DCS/Procédure/By-pass">Modifications DCS / Procédure / By‑pass</option>
          </select>
        </div>
        <!-- Quatrième ligne : opérateur -->
        <div>
          <label for="operateur_sel">Opérateur (salle de contrôle)&nbsp;:</label>
          <select id="operateur_sel" name="operateur_sel">
            <option value="">--Tous--</option>
          </select>
        </div>
        <!-- Cinquième ligne : recherche texte libre (sur toute la largeur) -->
        <div style="grid-column: span 4;">
          <label for="texte">Recherche texte&nbsp;:</label>
          <input type="text" id="texte" name="texte">
        </div>
        <!-- Bouton de recherche aligné à droite -->
        <div style="grid-column: span 4; text-align: right;">
          <button type="submit" style="padding:0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border:none; border-radius:4px; cursor:pointer;">Rechercher</button>
        </div>
      </form>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Superviseur / Opérateur</th>
            <th>Chef d'équipe</th>
            <th>Quart / Rotation</th>
            <th>Secteur</th>
            <th>Consigne</th>
            <th>Commentaire</th>
          </tr>
        </thead>
        <tbody>
          <tr class="no-results"><td colspan="7">Aucun résultat pour le moment.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Mappage entre le type sélectionné et la clé localStorage
      var keyMap = {
        'quart_superviseur': 'rapports',
        'quart_control': 'rapportsControl',
        'rotation_superviseur': 'rotationsSuperviseur',
        'rotation_control': 'rotationsControl'
      };
function populateSelect(id, key, defaults) {
  const select = document.getElementById(id);
  let list = [];
  try { list = (localStorage.getItem(key) || '').split(/\n|;/).map(s => s.trim()).filter(Boolean); } catch(e){}
  const items = list.length ? list : (defaults || []);
  select.innerHTML = '<option value="">--Tous--</option>';
  items.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name; opt.textContent = name;
    select.appendChild(opt);
  });
}
document.addEventListener('DOMContentLoaded', () => {
  populateSelect('superviseur_sel','supervisorList',['Vincent Lévesque','Olivier Chrétien']);
  populateSelect('chef_sel','teamLeadList',['Étienne Picard','David Michaud','Danick Deschenes','Samuel Boucher','Jean-Chrystophe Vallée']);
  populateSelect('operateur_sel','operatorList',['Serge Landry','Raymond Émond','Vincent Morin','Éric-Hugo Bastien','Samuel Boucher','Vincent Lévesque','Olivier Chrétien']);
});
</script>
      var typeSelect = document.getElementById('reportType');
      var searchForm = document.getElementById('searchForm');
      var resultsTable = document.getElementById('resultsTable');

      // -----------------------------------------------------------------------------
      // Fonctions utilitaires pour peupler les listes et gérer la fusion de rapports
      // -----------------------------------------------------------------------------

      /**
       * Remplit un élément <select> avec les valeurs trouvées dans localStorage sous
       * une clé donnée. Si la clé n'existe pas ou ne contient pas un tableau,
       * aucune option supplémentaire n'est ajoutée.
       * @param {string} selectId   L'ID de l'élément <select> à remplir.
       * @param {string} storageKey La clé localStorage qui contient un tableau de
       *                            valeurs à ajouter aux options du select.
       */
      function populateSelect(selectId, storageKey, defaultArray) {
        var select = document.getElementById(selectId);
        if (!select) return;
        var listStr = localStorage.getItem(storageKey);
        var items;
        if (listStr && listStr.trim() !== '') {
          try {
            var trimmed = listStr.trim();
            if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
              items = JSON.parse(trimmed);
            } else {
              // Diviser la chaîne par retour à la ligne, virgule ou point-virgule
              items = listStr.split(/[\n;,]+/);
            }
          } catch (e) {
            items = listStr.split(/[\n;,]+/);
          }
        } else {
          // Utiliser la liste par défaut si fournie
          items = Array.isArray(defaultArray) ? defaultArray : [];
        }
        if (Array.isArray(items)) {
          items.forEach(function(item) {
            var val = (item || '').trim();
            if (!val || select.querySelector('option[value="' + val + '"]')) return;
            var option = document.createElement('option');
            option.value = val;
            option.textContent = val;
            select.appendChild(option);
          });
        }
      }

      /**
       * Concatène et aplatit toutes les listes de rapports pour tous les types.
       * Cela permet de rechercher et d'afficher les rapports sans filtrage initial.
       * @returns {Array<Object>} Un tableau contenant toutes les entrées aplaties.
       */
      function flattenAllReports() {
        var allFlat = [];
        Object.keys(keyMap).forEach(function(type) {
          var key = keyMap[type];
          var stored = localStorage.getItem(key);
          var data = stored ? JSON.parse(stored) : [];
          var flat = flattenReports(data, type);
          allFlat = allFlat.concat(flat);
        });
        return allFlat;
      }

      /**
       * Affiche le dernier rapport en se basant sur la date (ordre décroissant).
       * Utilisé lorsque aucun type spécifique n'est sélectionné dans le filtre.
       */
      function showLastReport() {
        var allFlat = flattenAllReports();
        if (!allFlat || allFlat.length === 0) {
          renderRows([]);
          return;
        }
        // Trier par date décroissante. Les dates sont stockées au format AAAA-MM-JJ,
        // ce qui permet une comparaison lexicographique fiable pour le tri.
        allFlat.sort(function(a, b) {
          var da = a.date || '';
          var db = b.date || '';
          return db.localeCompare(da);
        });
        // Afficher uniquement la première entrée (la plus récente)
        renderRows([allFlat[0]]);
      }

      // Fonction pour aplatir les rapports en entrées individuelles
      function flattenReports(arr, type) {
        var flat = [];
        (arr || []).forEach(function(r) {
          var cats = r.categories || [];
          // Valeur de quart ou rotation (pour filtrage)
          var quartVal = r.quart || r.rotation || '';
          // Déterminer le responsable et l'opérateur
          var responsable = r.superviseur || r.operateur || '';
          var operateur = r.operateur || '';
          var chef = r.chef_equipe || r.chef || '';
          if (cats.length === 0) {
            // Lorsque qu'il n'y a pas de catégorie, placer le résumé ou les événements dans le commentaire
            flat.push({
              date: r.date || '',
              responsable: responsable,
              operateur: operateur,
              chef: chef,
              quart: quartVal,
              secteur: '',
              consigne: '',
              commentaire: (r.resume || r.resume_supp || r.resume_jour || r.resume_rotation || r.evt || r.evt_sst || r.evt_env || r.travaux || '')
            });
          } else {
            cats.forEach(function(cat) {
              flat.push({
                date: r.date || '',
                responsable: responsable,
                operateur: operateur,
                chef: chef,
                quart: quartVal,
                secteur: cat.categorie || '',
                consigne: cat.consigne || '',
                commentaire: cat.commentaire || ''
              });
            });
          }
        });
        return flat;
      }

      // Afficher les lignes
      function renderRows(items) {
        var tbody = resultsTable.querySelector('tbody');
        tbody.innerHTML = '';
        if (!items || items.length === 0) {
          var tr = document.createElement('tr');
          tr.className = 'no-results';
          var td = document.createElement('td');
          // Adapter le colspan au nombre de colonnes de la table (7 colonnes)
          td.colSpan = 7;
          td.textContent = 'Aucun résultat pour le moment.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        items.forEach(function(item) {
          var tr = document.createElement('tr');
          // Date
          var tdDate = document.createElement('td');
          tdDate.textContent = item.date;
          tr.appendChild(tdDate);
          // Superviseur / Opérateur
          var tdResp = document.createElement('td');
          tdResp.textContent = item.responsable;
          tr.appendChild(tdResp);
          // Chef d'équipe
          var tdChef = document.createElement('td');
          tdChef.textContent = item.chef || '';
          tr.appendChild(tdChef);
          // Quart / Rotation
          var tdQuart = document.createElement('td');
          tdQuart.textContent = item.quart || '';
          tr.appendChild(tdQuart);
          // Secteur
          var tdSecteur = document.createElement('td');
          tdSecteur.textContent = item.secteur || '';
          tr.appendChild(tdSecteur);
          // Consigne
          var tdCons = document.createElement('td');
          tdCons.textContent = item.consigne || '';
          tr.appendChild(tdCons);
          // Commentaire
          var tdComm = document.createElement('td');
          tdComm.textContent = item.commentaire || '';
          tr.appendChild(tdComm);
          tbody.appendChild(tr);
        });
      }

      // Charger et afficher initialement selon le type sélectionné
      function loadAndDisplay() {
        var selectedType = typeSelect.value;
        if (!selectedType) {
          // Lorsque le type est vide, afficher le dernier rapport enregistré
          showLastReport();
          return;
        }
        var key = keyMap[selectedType] || 'rapports';
        var stored = localStorage.getItem(key);
        var data = stored ? JSON.parse(stored) : [];
        var flat = flattenReports(data, selectedType);
        renderRows(flat);
      }

      // Exécuter la recherche avec filtres
      searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var dateDebut = document.getElementById('date_debut').value;
        var supSel = document.getElementById('superviseur_sel').value;
        var chefSel = document.getElementById('chef_sel').value;
        var quartSel = document.getElementById('quart_sel').value;
        var secteurSel = document.getElementById('secteur_sel').value;
        var opSel = document.getElementById('operateur_sel').value;
        var texteSel = document.getElementById('texte').value.toLowerCase();
        var selectedType = typeSelect.value;
        var flat = [];
        if (!selectedType) {
          // Si aucun type n'est sélectionné, fusionner toutes les données
          flat = flattenAllReports();
        } else {
          var key = keyMap[selectedType] || 'rapports';
          var stored = localStorage.getItem(key);
          var data = stored ? JSON.parse(stored) : [];
          flat = flattenReports(data, selectedType);
        }
        var results = [];
        flat.forEach(function(it) {
          // Filtre par date de début
          if (dateDebut && it.date < dateDebut) return;
          // Filtre superviseur
          if (supSel && it.responsable !== supSel) return;
          // Filtre chef d'équipe
          if (chefSel && it.chef !== chefSel) return;
          // Filtre quart ou rotation
          if (quartSel && it.quart !== quartSel) return;
          // Filtre secteur
          if (secteurSel && it.secteur !== secteurSel) return;
          // Filtre opérateur (sélecteur - correspondance exacte)
          if (opSel && it.operateur !== opSel) return;
          // Filtre texte libre sur superviseur/opérateur, secteur, consigne et commentaire
          var searchSpace = (it.responsable + ' ' + it.chef + ' ' + it.operateur + ' ' + it.secteur + ' ' + it.consigne + ' ' + it.commentaire).toLowerCase();
          if (texteSel && searchSpace.indexOf(texteSel) === -1) return;
          results.push(it);
        });
        renderRows(results);
      });

      // Changer de type déclenche le rechargement des données
      typeSelect.addEventListener('change', loadAndDisplay);

      // Attacher l'action d'impression des résultats
      var printBtn = document.getElementById('printResults');
      if (printBtn) {
        printBtn.addEventListener('click', function() {
          // Imprimer uniquement la table des résultats et masquer le formulaire et les boutons.
          window.print();
        });
      }

      // Chargement initial des listes déroulantes avec valeurs par défaut au besoin
      populateSelect('superviseur_sel', 'supervisorList', ['Vincent Lévesque','Olivier Chrétien']);
      populateSelect('chef_sel', 'teamLeadList', ['Jean Dupont','Marie Tremblay','Alain Gagnon','Sophie Lemaire']);
      populateSelect('operateur_sel', 'operatorList', ['Opérateur 1','Opérateur 2']);

      // Chargement initial du tableau
      loadAndDisplay();
    });
  </script>

  <!-- Script de rafraîchissement automatique pour recharger la page -->
  <script>
    (function() {
      var REFRESH_INTERVAL = 30 * 60 * 1000;
      var COUNTDOWN_SECONDS = 20;
      var refreshTimer;
      function startRefreshTimer() {
        refreshTimer = setTimeout(promptRefresh, REFRESH_INTERVAL);
      }
      function promptRefresh() {
        var overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.6)';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.style.zIndex = '9999';
        var modal = document.createElement('div');
        modal.style.background = '#ffffff';
        modal.style.padding = '2rem';
        modal.style.borderRadius = '8px';
        modal.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
        modal.style.textAlign = 'center';
        var msg = document.createElement('p');
        var remaining = COUNTDOWN_SECONDS;
        msg.textContent = 'Une mise à jour sera appliquée dans ' + remaining + ' secondes.';
        modal.appendChild(msg);
        var btnUpdate = document.createElement('button');
        btnUpdate.textContent = 'Mettre à jour maintenant';
        btnUpdate.style.marginRight = '1rem';
        var btnLater = document.createElement('button');
        btnLater.textContent = 'Plus tard';
        modal.appendChild(btnUpdate);
        modal.appendChild(btnLater);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        var interval = setInterval(function() {
          remaining--;
          msg.textContent = 'Une mise à jour sera appliquée dans ' + remaining + ' secondes.';
          if (remaining <= 0) {
            clearInterval(interval);
            triggerRefresh();
          }
        }, 1000);
        btnUpdate.onclick = function() {
          clearInterval(interval);
          triggerRefresh();
        };
        btnLater.onclick = function() {
          clearInterval(interval);
          document.body.removeChild(overlay);
          startRefreshTimer();
        };
      }
      function triggerRefresh() {
        window.location.reload(true);
      }
      document.addEventListener('DOMContentLoaded', function() {
        startRefreshTimer();
      });
    })();
  </script> 
   <script>
  // --------- Chargement initial depuis la base (Apps Script) ----------
  // Adapter la clé selon votre feuille côté Apps Script
  (function(){
    const SHEET_KEY = 'ChangementQuart';
    fetch(`${ENDPOINT}?sheet=${encodeURIComponent(SHEET_KEY)}`)
      .then(resp => resp.json())
      .then(rows => {
        const rapports = rows.map(row => ({
          date:        row.date || '',
          superviseur: row.superviseur || '',
          quart:       row.quart || '',
          // On aplatit dans le même format que les données locales
          consigne:    row.action || '',
          commentaire: row.commentaire || '',
          secteur:     row.secteur || '',
          statut:      row.statut || ''
        }));
        // Fusionne avec localStorage si besoin, puis affiche
        const flat = rapports.map(it => ({
          date: it.date,
          responsable: it.superviseur,
          chef: '',
          quart: it.quart,
          secteur: it.secteur,
          consigne: it.consigne,
          commentaire: it.commentaire,
          operateur: ''
        }));
        // Si un type est sélectionné, on re-filtre via le submit existant;
        // sinon on affiche ces résultats pré-chargés
        const tbody = document.querySelector('table tbody');
        if (tbody) {
          tbody.innerHTML = '';
          flat.forEach(item => {
            const tr = document.createElement('tr');
            const cells = [
              item.date, item.responsable, item.chef, item.quart,
              item.secteur, item.consigne, item.commentaire
            ];
            cells.forEach(text => {
              const td = document.createElement('td');
              td.textContent = text || '';
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        }
      })
      .catch(err => console.error('hub GET error:', err));
  })();
</script>
</body>
</html>
