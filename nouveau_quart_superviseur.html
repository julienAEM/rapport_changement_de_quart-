<script>
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxaGBM2UyvLY0cFXJkzYpFsJpXi2uGuzhFi7n6N5SwWrLkxWFWbYKkOe7lDPIQzyoTf0A/exec';
  // ENVOI (POST) vers la feuille cible
  function sendToHub(payload, SHEET_KEY) {
    const body = Object.assign({_sheet: changementQuart }, payload);
    return fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    }).then(r => r.json());
  }
  // LECTURE (GET) d’une feuille précise
  function fetchFromHub(ChangementQuart) {
    return fetch(`${ENDPOINT}?sheet=${encodeURIComponent(ChangementQuart)}`)
      .then(r => r.json());
  }
</script>
<!DOCTYPE html>
<!--
  Formulaire de changement de quart pour le superviseur. Cette version
  remplace l'envoi automatique par trois actions distinctes : enregistrer
  dans la base de données, envoyer par courriel et imprimer. Les listes
  déroulantes (superviseur, chef d'équipe et quart) sont renseignées à
  partir de localStorage. Les catégories sont les mêmes que dans la
  version originale du formulaire.
-->
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Changement de quart – Opération</title>
  <style>
    :root {
      --primary-color: #253746;
      --secondary-color: #324e67;
      --accent-color: #0078C8;
      --text-light: #ffffff;
      --field-bg: #f5f5f5;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--primary-color);
      color: var(--text-light);
    }
    .form-wrapper {
      max-width: 1000px;
      margin: 2rem auto;
      background: var(--secondary-color);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .form-header {
      background: var(--primary-color);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      border-bottom: 3px solid var(--accent-color);
    }
    .form-header img { height: 50px; margin-right: 1rem; }
    .form-header h1 { font-size: 1.5rem; color: var(--text-light); margin: 0; }
    .link-buttons { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
    .link-button {
      display: inline-block;
      padding: 0.7rem 1.4rem;
      background: var(--accent-color);
      color: var(--text-light);
      border-radius: 4px;
      text-decoration: none;
      font-size: 1rem;
    }
    .link-button:hover { background: #005fa0; }
    .form-content { padding: 2rem; }
    label { display: block; margin-top: 0.8rem; font-weight: bold; color: var(--text-light); }
    input[type="text"], input[type="date"], textarea, select {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.2rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
      background: var(--field-bg);
      color: #333;
    }
    textarea { resize: vertical; min-height: 60px; }
    table.team-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    table.team-table th, table.team-table td {
      border: 1px solid #ddd;
      padding: 0.4rem;
      text-align: left;
    }
    table.team-table th { background: var(--accent-color); color: var(--text-light); }
    .status-btn {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      margin-right: 0.3rem;
      cursor: pointer;
    }
    .status-btn.arr { background-color: red; }
    .status-btn.func { background-color: green; }
    .status-btn.selected {
      box-shadow: 0 0 0 3px #fff inset;
      border: 2px solid #fff;
    }
    .state-text { display: none; margin-left: 0.5rem; font-weight: bold; color: var(--text-light); }
    @media print {
      .status-btn { display: none; }
      .link-buttons { display: none; }
      .state-text { display: inline; }
    }
  </style>
</head>
<body>
  <div class="form-wrapper">
    <div class="form-header">
      <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
      <h1>Changement de quart – Opération</h1>
    </div>
    <div class="link-buttons">
      <a class="link-button" href="index.html">Accueil</a>
      <a class="link-button" href="rapport_multi_search.html">Consulter les rapports</a>
    </div>
    <div class="form-content">
      <h2>Superviseur</h2>
      <label for="superviseur">Superviseur :</label>
      <select id="superviseur" name="superviseur">
        <option value="">--Sélectionnez--</option>
        <!-- Les options seront ajoutées dynamiquement -->
      </select>
      <label for="chef_equipe">Chef d'équipe :</label>
      <select id="chef_equipe" name="chef_equipe">
        <option value="">--Sélectionnez--</option>
        <!-- Options ajoutées dynamiquement -->
      </select>
      <label for="quart">Quart :</label>
      <select id="quart" name="quart">
        <option value="">--Sélectionnez--</option>
        <!-- Options ajoutées dynamiquement -->
      </select>
      <label for="date">Date :</label>
      <input id="date" name="date" type="date" />
      <label for="evt_sst">Événement SST :</label>
      <textarea id="evt_sst" name="evt_sst"></textarea>
      <label for="evt_env">Événement environnement et MDR :</label>
      <textarea id="evt_env" name="evt_env"></textarea>
      <!-- Suppression du champ travaux mécanique et remplacement par un résumé complet de la journée.
           Ce champ permet au superviseur d'indiquer les tâches accomplies pendant le quart. -->
      <label for="resume">Résumé de la journée :</label>
      <textarea id="resume" name="resume" style="min-height: 120px; overflow-y:hidden;"></textarea>

      <!-- Champ complémentaire permettant de saisir des observations supplémentaires. Ce
           champ suit les mêmes spécifications que le résumé principal et est
           également sauvegardé dans la base de données. -->
      <label for="resume_supp">A faire ou a continuer&nbsp;:</label>
      <textarea id="resume_supp" name="resume_supp" style="min-height: 120px; overflow-y:hidden;"></textarea>
      <table class="team-table" id="categoryTable">
        <thead>
          <tr>
            <th>Catégorie</th>
            <th>Consigne</th>
            <th>Commentaires</th>
            <th>État</th>
          </tr>
        </thead>
        <tbody>
          <tr data-category="Digestion">
            <td>Digestion</td>
            <td><textarea name="digestion_consigne"></textarea></td>
            <td><textarea name="digestion_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Cristalisation">
            <td>Cristalisation</td>
            <td><textarea name="cristalisation_consigne"></textarea></td>
            <td><textarea name="cristalisation_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Centrifuge">
            <td>Centrifuge</td>
            <td><textarea name="centrifuge_consigne"></textarea></td>
            <td><textarea name="centrifuge_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Décomposition (Harpers)">
            <td>Décomposition (Harpers)</td>
            <td><textarea name="decomposition_consigne"></textarea></td>
            <td><textarea name="decomposition_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Calcination (F04)">
            <td>Calcination (F04)</td>
            <td><textarea name="calcination_f04_consigne"></textarea></td>
            <td><textarea name="calcination_f04_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Lavage S02">
            <td>Lavage S02</td>
            <td><textarea name="lavage_s02_consigne"></textarea></td>
            <td><textarea name="lavage_s02_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Buhler">
            <td>Buhler</td>
            <td><textarea name="buhler_consigne"></textarea></td>
            <td><textarea name="buhler_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="HP60 (Mega Pulse)">
            <td>HP60 (Mega Pulse)</td>
            <td><textarea name="hp60_consigne"></textarea></td>
            <td><textarea name="hp60_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Mini-Pulse">
            <td>Mini-Pulse</td>
            <td><textarea name="mini_pulse_consigne"></textarea></td>
            <td><textarea name="mini_pulse_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Fabrication de Puck">
            <td>Fabrication de Puck</td>
            <td><textarea name="fabrication_puck_consigne"></textarea></td>
            <td><textarea name="fabrication_puck_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Traitement des eaux">
            <td>Traitement des eaux</td>
            <td><textarea name="traitement_eaux_consigne"></textarea></td>
            <td><textarea name="traitement_eaux_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="action-buttons" style="margin-top:1rem; display:flex; gap:1rem;">
        <button type="button" id="saveBtn" style="flex:1; padding:0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border:none; border-radius:4px; cursor:pointer;">Enregistrer</button>
        <button type="button" id="emailBtn" style="flex:1; padding:0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border:none; border-radius:4px; cursor:pointer;">Envoyer par courriel</button>
        <button type="button" id="printBtn" style="flex:1; padding:0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border:none; border-radius:4px; cursor:pointer;">Imprimer</button>
      </div>
    </div>
  </div>
  <script>
    // Ajustement automatique de la hauteur du champ résumé en fonction de son contenu
    function autoGrow(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }
    // Définir la date par défaut
    document.addEventListener('DOMContentLoaded', function() {
      var dateInput = document.getElementById('date');
      if (dateInput) {
        var today = new Date().toISOString().substr(0, 10);
        dateInput.value = today;
      }
      // Charger les listes de choix depuis localStorage
      var supervisorSelect = document.getElementById('superviseur');
      if (supervisorSelect) {
        var storedSup = localStorage.getItem('supervisorList') || '';
        var defaultSup = ['Vincent Lévesque','Olivier Chrétien'];
        var supArray = [];
        if (storedSup.trim() !== '') {
          supArray = storedSup.split(/[\n;]/).map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
        } else {
          supArray = defaultSup;
        }
        supArray.forEach(function(name) {
          var opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          supervisorSelect.appendChild(opt);
        });
      }
      var teamLeadSelect = document.getElementById('chef_equipe');
      if (teamLeadSelect) {
        var storedLeads = localStorage.getItem('teamLeadList') || '';
        var defaultLeads = ['Jean Dupont','Marie Tremblay','Alain Gagnon','Sophie Lemaire'];
        var leadsArray = [];
        if (storedLeads.trim() !== '') {
          leadsArray = storedLeads.split(/[\n;]/).map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
        } else {
          leadsArray = defaultLeads;
        }
        leadsArray.forEach(function(name) {
          var opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          teamLeadSelect.appendChild(opt);
        });
      }
      var shiftSelect = document.getElementById('quart');
      if (shiftSelect) {
        var storedShift = localStorage.getItem('shiftList') || '';
        var defaultShift = ['Jour','Nuit'];
        var shiftArray = [];
        if (storedShift.trim() !== '') {
          shiftArray = storedShift.split(/[\n;]/).map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
        } else {
          shiftArray = defaultShift;
        }
        shiftArray.forEach(function(name) {
          var opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          shiftSelect.appendChild(opt);
        });
      }

      // Charger un brouillon existant après avoir rempli les listes
      loadDraft();

      // Mettre en place la sauvegarde automatique du brouillon à chaque modification
      var inputs = document.querySelectorAll('input, textarea, select');
      inputs.forEach(function(el) {
        el.addEventListener('input', function() {
          saveDraft();
        });
        el.addEventListener('change', function() {
          saveDraft();
        });
      });

      // Ajuster la hauteur du champ résumé lors du chargement et à chaque saisie
      var resumeField = document.getElementById('resume');
      if (resumeField) {
        autoGrow(resumeField);
        resumeField.addEventListener('input', function() { autoGrow(this); });
      }
      // Ajuster la hauteur du champ d'observations supplémentaires
      var resumeSupp = document.getElementById('resume_supp');
      if (resumeSupp) {
        autoGrow(resumeSupp);
        resumeSupp.addEventListener('input', function() { autoGrow(this); });
      }
    });
    // Fonction pour basculer l'état d'une ligne
    function toggleStatus(btn) {
      var container = btn.parentElement;
      var buttons = container.querySelectorAll('.status-btn');
      buttons.forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      var span = container.querySelector('.state-text');
      span.textContent = btn.textContent;

      // Mettre à jour le brouillon après modification de l'état
      saveDraft();
    }
    // Collecte des données du formulaire
    function collectReportData() {
      var superviseur = document.getElementById('superviseur').value;
      var chef = document.getElementById('chef_equipe').value;
      var quart = document.getElementById('quart').value;
      var dateVal = document.getElementById('date').value;
      var evtSst = document.getElementById('evt_sst').value;
      var evtEnv = document.getElementById('evt_env').value;
      // Le champ travaux mécanique a été supprimé au profit d'un résumé complet de la journée
      var resume = document.getElementById('resume').value;
      var resume_supp = document.getElementById('resume_supp').value;
      var cats = [];
      var rows = document.querySelectorAll('#categoryTable tbody tr');
      rows.forEach(function(row) {
        var catName = row.getAttribute('data-category');
        var consigne = row.querySelector('textarea[name$="_consigne"]').value;
        var commentaire = row.querySelector('textarea[name$="_commentaire"]').value;
        var selectedBtn = row.querySelector('.status-btn.selected');
        var etat = selectedBtn ? selectedBtn.textContent : '';
        cats.push({ categorie: catName, consigne: consigne, commentaire: commentaire, etat: etat });
      });
      return { date: dateVal, superviseur: superviseur, chef_equipe: chef, quart: quart, evt_sst: evtSst, evt_env: evtEnv, resume: resume, resume_supp: resume_supp, categories: cats };
    }
    // Enregistrer le brouillon actuel pour revenir plus tard
    function saveDraft() {
      var draft = collectReportData();
      try {
        localStorage.setItem('draft_quart_superviseur', JSON.stringify(draft));
      } catch (e) {
        console.error('Erreur lors de l\'enregistrement du brouillon : ', e);
      }
    }
    // Charger un brouillon s'il existe et préremplir le formulaire
    function loadDraft() {
      try {
        var stored = localStorage.getItem('draft_quart_superviseur');
        if (stored) {
          var draft = JSON.parse(stored);
          // Remplir les champs principaux
          if (document.getElementById('superviseur')) document.getElementById('superviseur').value = draft.superviseur || '';
          if (document.getElementById('chef_equipe')) document.getElementById('chef_equipe').value = draft.chef_equipe || '';
          if (document.getElementById('quart')) document.getElementById('quart').value = draft.quart || '';
          if (document.getElementById('date')) document.getElementById('date').value = draft.date || '';
          if (document.getElementById('evt_sst')) document.getElementById('evt_sst').value = draft.evt_sst || '';
          if (document.getElementById('evt_env')) document.getElementById('evt_env').value = draft.evt_env || '';
          // Le champ travaux mécanique est obsolète; charger uniquement le résumé s'il existe
          if (document.getElementById('resume')) document.getElementById('resume').value = draft.resume || '';
          if (document.getElementById('resume_supp')) document.getElementById('resume_supp').value = draft.resume_supp || '';
          // Remplir les catégories
          (draft.categories || []).forEach(function(cat) {
            var row = document.querySelector('#categoryTable tbody tr[data-category="' + cat.categorie + '"]');
            if (row) {
              var consigneArea = row.querySelector('textarea[name$="_consigne"]');
              var commentaireArea = row.querySelector('textarea[name$="_commentaire"]');
              if (consigneArea) consigneArea.value = cat.consigne || '';
              if (commentaireArea) commentaireArea.value = cat.commentaire || '';
              var btns = row.querySelectorAll('.status-btn');
              btns.forEach(function(b) { b.classList.remove('selected'); });
              if (cat.etat) {
                btns.forEach(function(b) {
                  if (b.textContent === cat.etat) {
                    b.classList.add('selected');
                    var span = row.querySelector('.state-text');
                    if (span) span.textContent = cat.etat;
                  }
                });
              }
            }
          });
        }
      } catch (e) {
        console.error('Erreur lors du chargement du brouillon : ', e);
      }
    }
     
    
    // Enregistrer dans localStorage
    function saveReport() {
      var report = collectReportData();
      report._sheet = 'ChangementQuart';
      try {
            report._sheet = 'ChangementQuart'; 
    fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(report)
    });
        var existing = localStorage.getItem('rapports');
        var arr = existing ? JSON.parse(existing) : [];
        arr.push(report);
        localStorage.setItem('rapports', JSON.stringify(arr));
        alert('Rapport enregistré dans la base de données.');
        // Suppression du brouillon puisque le rapport est désormais enregistré
       
        
        localStorage.removeItem('draft_quart_superviseur');
      } catch (e) {
        console.error('Erreur lors de l\'enregistrement : ', e);
        alert('Une erreur est survenue lors de l\'enregistrement.');
      }
    }
    // Envoyer par courriel
    function sendEmail() {
      var report = collectReportData();
      report._sheet = 'ChangementQuart';
      // Enregistrer avant d'envoyer pour conserver le rapport
      saveReport();
      // Construire un corps de courriel plus structuré pour faciliter la lecture
      var body = '';
      body += 'Type: Changement de quart – opération\n';
      body += 'Date: ' + report.date + '\n';
      body += 'Quart: ' + report.quart + '\n';
      body += 'Superviseur: ' + report.superviseur + '\n';
      if (report.chef_equipe) {
        body += "Chef d'équipe: " + report.chef_equipe + '\n';
      }
      body += '\n';
      // Inclure les résumés et observations seulement s'ils existent
      if (report.resume) {
        body += 'Résumé de la journée:\n' + report.resume + '\n\n';
      }
      if (report.resume_supp) {
        body += 'A faire ou a continuer:\n' + report.resume_supp + '\n\n';
      }
      // Inclure les événements SST et environnementaux
      if (report.evt_sst) {
        body += 'Événement SST:\n' + report.evt_sst + '\n\n';
      }
      if (report.evt_env) {
        body += 'Événement environnement et MDR:\n' + report.evt_env + '\n\n';
      }
      // Détail des catégories avec indentation et lignes vides pour la lisibilité
      body += 'Catégories:\n';
      report.categories.forEach(function(cat) {
        body += '- ' + cat.categorie + '\n';
        if (cat.consigne) body += '  Consigne: ' + cat.consigne + '\n';
        if (cat.commentaire) body += '  Commentaire: ' + cat.commentaire + '\n';
        if (cat.etat) body += '  État: ' + cat.etat + '\n';
        body += '\n';
      });
      // Préparation de la liste de destinataires
      var emailListRaw = localStorage.getItem('emailList') || '';
      var emailArray = emailListRaw.split(/[;\n]+/).map(function(e) { return e.trim(); }).filter(function(e) { return e.length > 0; });
      var toField = emailArray.join(',');
      // Sujet plus descriptif
      var subject = 'Changement de quart (opération) – ' + report.date;
      var mailtoLink = 'mailto:' + encodeURIComponent(toField) + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
      // Ouvrir le client mail avec le brouillon prérempli
      window.location.href = mailtoLink;
      // Supprimer le brouillon une fois le courriel préparé
      localStorage.removeItem('draft_quart_superviseur');
    }
    // Écouteurs de boutons
    document.getElementById('saveBtn').addEventListener('click', function() { saveReport(); });
    document.getElementById('emailBtn').addEventListener('click', function() { sendEmail(); });
    document.getElementById('printBtn').addEventListener('click', function() { window.print(); });
  </script>
  <!-- Script de rafraîchissement automatique avec sauvegarde du brouillon -->
  <script>
    (function() {
      // Durée avant d'afficher la fenêtre de mise à jour (30 minutes)
      var REFRESH_INTERVAL = 30 * 60 * 1000;
      // Durée du compte à rebours en secondes
      var COUNTDOWN_SECONDS = 20;
      var refreshTimer;
      function startRefreshTimer() {
        refreshTimer = setTimeout(promptRefresh, REFRESH_INTERVAL);
      }
      function promptRefresh() {
        // Créer une superposition semi-transparente
        var overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.6)';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.style.zIndex = '9999';
        // Créer la boîte de dialogue
        var modal = document.createElement('div');
        modal.style.background = '#ffffff';
        modal.style.padding = '2rem';
        modal.style.borderRadius = '8px';
        modal.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
        modal.style.textAlign = 'center';
        // Message avec compteur
        var msg = document.createElement('p');
        var remaining = COUNTDOWN_SECONDS;
        msg.textContent = 'Une mise à jour sera appliquée dans ' + remaining + ' secondes.';
        modal.appendChild(msg);
        // Bouton pour mettre à jour immédiatement
        var btnUpdate = document.createElement('button');
        btnUpdate.textContent = 'Mettre à jour maintenant';
        btnUpdate.style.marginRight = '1rem';
        // Bouton pour reporter la mise à jour
        var btnLater = document.createElement('button');
        btnLater.textContent = 'Plus tard';
        modal.appendChild(btnUpdate);
        modal.appendChild(btnLater);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        // Compte à rebours
        var interval = setInterval(function() {
          remaining--;
          msg.textContent = 'Une mise à jour sera appliquée dans ' + remaining + ' secondes.';
          if (remaining <= 0) {
            clearInterval(interval);
            triggerRefresh();
          }
        }, 1000);
        // Action pour mise à jour maintenant
        btnUpdate.onclick = function() {
          clearInterval(interval);
          triggerRefresh();
        };
        // Action pour plus tard
        btnLater.onclick = function() {
          clearInterval(interval);
          document.body.removeChild(overlay);
          startRefreshTimer();
        };
      }
      function triggerRefresh() {
        // Sauvegarder un brouillon si la fonction existe
        try {
          if (typeof saveDraft === 'function') {
            saveDraft();
          }
        } catch (e) {}
        window.location.reload(true);
      }
      document.addEventListener('DOMContentLoaded', function() {
        startRefreshTimer();
      });
    })();
  </script>
</body>
</html>
