<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyJDaQEVNkmRUJsdSXyT2uoMbeQjhiEnV1TuuCGjG7Ow0FofRDOq0Oex8FvLqWCAPCgrA/exec';

  // ENVOI (POST) vers la feuille cible
  function sendToHub(payload, SHEET_KEY) {
    const body = Object.assign({_sheet: SHEET_KEY}, payload);
    return fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    }).then(r => r.json());
  }

  // LECTURE (GET) d’une feuille précise
  function fetchFromHub(SHEET_KEY) {
    return fetch(`${ENDPOINT}?sheet=${encodeURIComponent(SHEET_KEY)}`)
      .then(r => r.json());
  }
</script>
<!DOCTYPE html>
<!--
  Formulaire pour le changement de rotation destiné aux superviseurs. Cette page
  reprend l'apparence du formulaire de changement de quart en y ajoutant les
  champs nécessaires pour une rotation complète.
-->
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Changement de rotation – Superviseur</title>
  <style>
    :root {
      --primary-color: #253746;
      --secondary-color: #324e67;
      --accent-color: #0078C8;
      --text-light: #ffffff;
      --field-bg: #f5f5f5;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--primary-color);
      color: var(--text-light);
    }
    .form-wrapper {
      max-width: 1000px;
      margin: 2rem auto;
      background: var(--secondary-color);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .form-header {
      background: var(--primary-color);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      border-bottom: 3px solid var(--accent-color);
    }
    .form-header img { height: 50px; margin-right: 1rem; }
    .form-header h1 { font-size: 1.5rem; color: var(--text-light); margin: 0; }
    .link-buttons { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
    .link-button { display: inline-block; padding: 0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border-radius: 4px; text-decoration: none; font-size: 1rem; }
    .link-button:hover { background: #005fa0; }
    .form-content { padding: 2rem; }
    label { display: block; margin-top: 0.8rem; font-weight: bold; color: var(--text-light); }
    input[type="text"], input[type="date"], textarea, select {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.2rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
      background: var(--field-bg);
      color: #333;
    }
    textarea { resize: vertical; min-height: 60px; }
    table.team-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    table.team-table th, table.team-table td { border: 1px solid #ddd; padding: 0.4rem; text-align: left; }
    table.team-table th { background: var(--accent-color); color: var(--text-light); }
    .status-btn {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      margin-right: 0.3rem;
      cursor: pointer;
    }
    .status-btn.arr { background-color: red; }
    .status-btn.func { background-color: green; }
    .status-btn.selected { box-shadow: 0 0 0 3px #fff inset; border: 2px solid #fff; }
    .state-text { display: none; margin-left: 0.5rem; font-weight: bold; color: var(--text-light); }
    @media print {
      .status-btn { display: none; }
      .link-buttons { display: none; }
      .state-text { display: inline; }
    }
  </style>
</head>
<body>
  <div class="form-wrapper">
    <div class="form-header">
      <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&amp;height=64&amp;name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
      <h1>Changement de rotation – Superviseur</h1>
    </div>
    <div class="link-buttons">
      <a class="link-button" href="index.html">Accueil</a>
      <a class="link-button" href="rapport_multi_search.html">Consulter les rapports</a>
    </div>
    <div class="form-content">
      <label for="superviseur">Superviseur :</label>
      <select id="superviseur" name="superviseur">
        <option value="">--Sélectionnez--</option>
        <option value="Vincent Lévesque">Vincent Lévesque</option>
        <option value="Olivier Chrétien">Olivier Chrétien</option>
      </select>
      <label for="chef">Chef d'équipe :</label>
      <select id="chef" name="chef">
        <option value="">--Sélectionnez--</option>
      </select>
      <label for="rotation">Rotation :</label>
      <select id="rotation" name="rotation">
        <option value="">--Sélectionnez--</option>
        <option value="Jour">Jour</option>
        <option value="Nuit">Nuit</option>
      </select>
      <label for="date">Date :</label>
      <input id="date" name="date" type="date" />
      <!-- Regroupement des événements SST, environnement, etc. dans un seul champ -->
      <label for="evt">Événements SST / Environnement :</label>
      <textarea id="evt" name="evt"></textarea>
      <!-- Champ de résumé pour la rotation entière -->
      <label for="resume">Résumé de la rotation :</label>
      <textarea id="resume" name="resume" style="min-height: 120px; overflow-y:hidden;"></textarea>
      <!-- Tableau des catégories -->
      <table class="team-table" id="categoryTable">
        <thead>
          <tr>
            <th>Catégorie</th>
            <th>Consigne</th>
            <th>Commentaires</th>
            <th>État</th>
          </tr>
        </thead>
        <tbody>
          <!-- Catégories identiques au formulaire de quart -->
          <tr data-category="Digestion">
            <td>Digestion</td>
            <td><textarea name="digestion_consigne"></textarea></td>
            <td><textarea name="digestion_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Cristalisation">
            <td>Cristalisation</td>
            <td><textarea name="cristalisation_consigne"></textarea></td>
            <td><textarea name="cristalisation_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Centrifuge">
            <td>Centrifuge</td>
            <td><textarea name="centrifuge_consigne"></textarea></td>
            <td><textarea name="centrifuge_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Décomposition (Harpers)">
            <td>Décomposition (Harpers)</td>
            <td><textarea name="decomposition_consigne"></textarea></td>
            <td><textarea name="decomposition_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Calcination (F04)">
            <td>Calcination (F04)</td>
            <td><textarea name="calcination_f04_consigne"></textarea></td>
            <td><textarea name="calcination_f04_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Lavage S02">
            <td>Lavage S02</td>
            <td><textarea name="lavage_s02_consigne"></textarea></td>
            <td><textarea name="lavage_s02_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Buhler">
            <td>Buhler</td>
            <td><textarea name="buhler_consigne"></textarea></td>
            <td><textarea name="buhler_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="HP60 (Mega Pulse)">
            <td>HP60 (Mega Pulse)</td>
            <td><textarea name="hp60_consigne"></textarea></td>
            <td><textarea name="hp60_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Mini-Pulse">
            <td>Mini-Pulse</td>
            <td><textarea name="mini_pulse_consigne"></textarea></td>
            <td><textarea name="mini_pulse_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Fabrication de Puck">
            <td>Fabrication de Puck</td>
            <td><textarea name="fabrication_puck_consigne"></textarea></td>
            <td><textarea name="fabrication_puck_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <tr data-category="Traitement des eaux">
            <td>Traitement des eaux</td>
            <td><textarea name="traitement_eaux_consigne"></textarea></td>
            <td><textarea name="traitement_eaux_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
          <!-- Ajout d'une catégorie pour les interventions sur le système et procédures -->
          <tr data-category="Modifications DCS/Procédure/By-pass">
            <td>Modifications DCS / Procédure / By‑pass</td>
            <td><textarea name="modifications_consigne"></textarea></td>
            <td><textarea name="modifications_commentaire"></textarea></td>
            <td>
              <button class="status-btn arr" type="button" onclick="toggleStatus(this)">Arrêt</button>
              <button class="status-btn func" type="button" onclick="toggleStatus(this)">Fonction</button>
              <span class="state-text"></span>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="action-buttons" style="margin-top:1rem; display:flex; gap:1rem;">
        <button type="button" id="saveBtn" style="flex:1; padding:0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border:none; border-radius:4px; cursor:pointer;">Enregistrer</button>
        <button type="button" id="emailBtn" style="flex:1; padding:0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border:none; border-radius:4px; cursor:pointer;">Envoyer par courriel</button>
        <button type="button" id="printBtn" style="flex:1; padding:0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border:none; border-radius:4px; cursor:pointer;">Imprimer</button>
      </div>
    </div>
  </div>
  <script>
    // Fonction pour faire grandir automatiquement la zone de résumé
    function autoGrow(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }
    function toggleStatus(btn) {
      var container = btn.parentElement;
      var buttons = container.querySelectorAll('.status-btn');
      buttons.forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      var span = container.querySelector('.state-text');
      span.textContent = btn.textContent;

      // Mettre à jour le brouillon après modification
      saveDraft();
    }
    document.addEventListener('DOMContentLoaded', function() {
      var dateInput = document.getElementById('date');
      if (dateInput) {
        var today = new Date().toISOString().substr(0, 10);
        dateInput.value = today;
      }
      // Charger un brouillon existant après initialisation de la date
      loadDraft();
      // Sauvegarder le brouillon à chaque modification de champ
      var inputs = document.querySelectorAll('input, textarea, select');
      inputs.forEach(function(el) {
        el.addEventListener('input', function() { saveDraft(); });
        el.addEventListener('change', function() { saveDraft(); });
      });

      // Ajuster la hauteur du résumé au chargement et à la saisie
      var resumeField = document.getElementById('resume');
      if (resumeField) {
        autoGrow(resumeField);
        resumeField.addEventListener('input', function() { autoGrow(this); });
      }
    });
    // Fonction pour collecter les données du formulaire
    function collectReportData() {
      var superviseur = document.getElementById('superviseur').value;
      var chef = document.getElementById('chef').value;
      var rotationVal = document.getElementById('rotation').value;
      var dateVal = document.getElementById('date').value;
      var evt = document.getElementById('evt').value;
      var resume = document.getElementById('resume').value;
      var cats = [];
      var rows = document.querySelectorAll('#categoryTable tbody tr');
      rows.forEach(function(row) {
        var catName = row.getAttribute('data-category');
        var consigne = row.querySelector('textarea[name$="_consigne"]').value;
        var commentaire = row.querySelector('textarea[name$="_commentaire"]').value;
        var selectedBtn = row.querySelector('.status-btn.selected');
        var etat = selectedBtn ? selectedBtn.textContent : '';
        cats.push({ categorie: catName, consigne: consigne, commentaire: commentaire, etat: etat });
      });
      return { superviseur: superviseur, chef: chef, rotation: rotationVal, date: dateVal, evt: evt, resume: resume, categories: cats };
    }
    // Enregistrer le brouillon pour la rotation superviseur
    function saveDraft() {
      var draft = collectReportData();
      try {
        localStorage.setItem('draft_rotation_superviseur', JSON.stringify(draft));
      } catch (e) {
        console.error('Erreur lors de l\'enregistrement du brouillon : ', e);
      }
    }
    // Charger un brouillon et pré-remplir le formulaire
    function loadDraft() {
      try {
        var stored = localStorage.getItem('draft_rotation_superviseur');
        if (stored) {
          var draft = JSON.parse(stored);
          if (document.getElementById('superviseur')) document.getElementById('superviseur').value = draft.superviseur || '';
          if (document.getElementById('chef')) document.getElementById('chef').value = draft.chef || '';
          if (document.getElementById('rotation')) document.getElementById('rotation').value = draft.rotation || '';
          if (document.getElementById('date')) document.getElementById('date').value = draft.date || '';
          if (document.getElementById('evt')) document.getElementById('evt').value = draft.evt || '';
          if (document.getElementById('resume')) document.getElementById('resume').value = draft.resume || '';
          // Catégories
          (draft.categories || []).forEach(function(cat) {
            var row = document.querySelector('#categoryTable tbody tr[data-category="' + cat.categorie + '"]');
            if (row) {
              var consigneArea = row.querySelector('textarea[name$="_consigne"]');
              var commentaireArea = row.querySelector('textarea[name$="_commentaire"]');
              if (consigneArea) consigneArea.value = cat.consigne || '';
              if (commentaireArea) commentaireArea.value = cat.commentaire || '';
              var btns = row.querySelectorAll('.status-btn');
              btns.forEach(function(b) { b.classList.remove('selected'); });
              if (cat.etat) {
                btns.forEach(function(b) {
                  if (b.textContent === cat.etat) {
                    b.classList.add('selected');
                    var span = row.querySelector('.state-text');
                    if (span) span.textContent = cat.etat;
                  }
                });
                
              }
            }
          });
        }
      } catch (e) {
        console.error('Erreur lors du chargement du brouillon : ', e);
      }
    }
    function saveReport() {
      var report = collectReportData();
      try {
        var existing = localStorage.getItem('rotationsSuperviseur');
        var arr = existing ? JSON.parse(existing) : [];
        arr.push(report);
        localStorage.setItem('rotationsSuperviseur', JSON.stringify(arr));
          fetch('https://script.google.com/macros/s/AKfycbxAHRKxZriIsOjUA0R_HiCEje24GTNnv8SsFcL3HPTjg3WIVFNjeSDzmJahusCABnQ2Wg/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(report)
      });
        alert('Rapport enregistré dans la base de données.');
        // Supprimer le brouillon après l'enregistrement
             
      });
        localStorage.removeItem('draft_rotation_superviseur');
      } catch (e) {
        console.error('Erreur lors de l\'enregistrement : ', e);
        alert('Une erreur est survenue lors de l\'enregistrement.');
      }
    }
    function sendEmail() {
      var report = collectReportData();
      // Enregistrer le rapport avant l'envoi
      saveReport();
      // Construire un corps de courriel clair et structuré
      var body = '';
      body += 'Type: Changement de rotation – superviseur\n';
      body += 'Date: ' + report.date + '\n';
      body += 'Rotation: ' + report.rotation + '\n';
      body += 'Superviseur: ' + report.superviseur + '\n';
      if (report.chef) {
        body += "Chef d'équipe: " + report.chef + '\n';
      }
      body += '\n';
      if (report.resume) {
        body += 'Résumé de la rotation:\n' + report.resume + '\n\n';
      }
      if (report.evt) {
        body += 'Événements SST / Environnement:\n' + report.evt + '\n\n';
      }
      body += 'Catégories:\n';
      report.categories.forEach(function(cat) {
        body += '- ' + cat.categorie + '\n';
        if (cat.consigne) body += '  Consigne: ' + cat.consigne + '\n';
        if (cat.commentaire) body += '  Commentaire: ' + cat.commentaire + '\n';
        if (cat.etat) body += '  État: ' + cat.etat + '\n';
        body += '\n';
      });
      // Préparer les destinataires
      var emailListRaw = localStorage.getItem('emailList') || '';
      var emailArray = emailListRaw.split(/[;\n]+/).map(function(e) { return e.trim(); }).filter(function(e) { return e.length > 0; });
      var toField = emailArray.join(',');
      var subject = 'Changement de rotation (superviseur) – ' + report.date;
      var mailtoLink = 'mailto:' + encodeURIComponent(toField) + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
      window.location.href = mailtoLink;
      // Supprimer le brouillon après préparation de l'email
      localStorage.removeItem('draft_rotation_superviseur');
    }
    document.getElementById('saveBtn').addEventListener('click', function() { saveReport(); });
    document.getElementById('emailBtn').addEventListener('click', function() { sendEmail(); });
    document.getElementById('printBtn').addEventListener('click', function() { window.print(); });
  </script>
  <!-- Script de rafraîchissement automatique avec sauvegarde du brouillon -->
  <script>
    (function() {
      var REFRESH_INTERVAL = 30 * 60 * 1000;
      var COUNTDOWN_SECONDS = 20;
      var refreshTimer;
      function startRefreshTimer() {
        refreshTimer = setTimeout(promptRefresh, REFRESH_INTERVAL);
      }
      function promptRefresh() {
        var overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.6)';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.style.zIndex = '9999';
        var modal = document.createElement('div');
        modal.style.background = '#ffffff';
        modal.style.padding = '2rem';
        modal.style.borderRadius = '8px';
        modal.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
        modal.style.textAlign = 'center';
        var msg = document.createElement('p');
        var remaining = COUNTDOWN_SECONDS;
        msg.textContent = 'Une mise à jour sera appliquée dans ' + remaining + ' secondes.';
        modal.appendChild(msg);
        var btnUpdate = document.createElement('button');
        btnUpdate.textContent = 'Mettre à jour maintenant';
        btnUpdate.style.marginRight = '1rem';
        var btnLater = document.createElement('button');
        btnLater.textContent = 'Plus tard';
        modal.appendChild(btnUpdate);
        modal.appendChild(btnLater);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        var interval = setInterval(function() {
          remaining--;
          msg.textContent = 'Une mise à jour sera appliquée dans ' + remaining + ' secondes.';
          if (remaining <= 0) {
            clearInterval(interval);
            triggerRefresh();
          }
        }, 1000);
        btnUpdate.onclick = function() {
          clearInterval(interval);
          triggerRefresh();
        };
        btnLater.onclick = function() {
          clearInterval(interval);
          document.body.removeChild(overlay);
          startRefreshTimer();
        };
      }
      function triggerRefresh() {
        try {
          if (typeof saveDraft === 'function') {
            saveDraft();
          }
        } catch (e) {}
        window.location.reload(true);
      }
      document.addEventListener('DOMContentLoaded', function() {
        startRefreshTimer();
      });
    })();
  </script>
</body>
</html>
