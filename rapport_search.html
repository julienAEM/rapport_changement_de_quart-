<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxaGBM2UyvLY0cFXJkzYpFsJpXi2uGuzhFi7n6N5SwWrLkxWFWbYKkOe7lDPIQzyoTf0A/exec';

  // ENVOI (POST) vers la feuille cible
  function sendToHub(payload, SHEET_KEY) {
    const body = Object.assign({_sheet: SHEET_KEY}, payload);
    return fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    }).then(r => r.json());
  }

  // LECTURE (GET) d’une feuille précise
  function fetchFromHub(SHEET_KEY) {
    return fetch(`${ENDPOINT}?sheet=${encodeURIComponent(SHEET_KEY)}`)
      .then(r => r.json());
  }
</script>
<!DOCTYPE html>

<!--
  Page de consultation des rapports avec filtrage dynamique. Cette version
  exploite localStorage pour lire les rapports enregistrés via le formulaire
  principal et affiche les résultats dans un tableau. La recherche permet de
  filtrer par date, superviseur, quart, catégorie et texte libre. Elle remplace
  l'ancienne page statique (rapport_search.html).
-->
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>Recherche de rapports</title>
  <style>
    :root {
      --primary-color: #253746;
      --secondary-color: #324e67;
      --accent-color: #0078C8;
      --text-light: #ffffff;
      --field-bg: #f5f5f5;
    }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: var(--primary-color); color: var(--text-light); }
    .wrapper { max-width: 1000px; margin: 2rem auto; background: var(--secondary-color); border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); overflow: hidden; }
    .header { background: var(--primary-color); padding: 1rem 2rem; display: flex; align-items: center; border-bottom: 3px solid var(--accent-color); }
    .header img { height: 50px; margin-right: 1rem; }
    .header h1 { font-size: 1.5rem; margin: 0; color: var(--text-light); }
    .nav-buttons { display: flex; justify-content: center; gap: 1rem; margin: 1rem; }
    .nav-button { display: inline-block; padding: 0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border-radius: 4px; text-decoration: none; font-size: 1rem; }
    .nav-button:hover { background: #005fa0; }
    .content { padding: 2rem; }
    form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
    input[type="date"], select, input[type="text"] { width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 4px; background: var(--field-bg); color: #333; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.6rem; text-align: left; }
    th { background: var(--accent-color); color: var(--text-light); }
    .no-results { text-align: center; padding: 1rem; }
  </style>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&amp;height=64&amp;name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png"/>
    <h1>Recherche de rapports</h1>
  </div>
  <div class="link-buttons">
  <a class="link-button" href="index.html">Retour vers Accueil</a>
  <a class="link-button" href="rapport_multi_search.html">Consulter les rapports</a>
</div>
  <div class="content">
    <form id="searchForm">
      <div>
        <label for="date_debut">Date début :</label>
        <input type="date" id="date_debut" name="date_debut"/>
      </div>
      <div>
        <label for="date_fin">Date fin :</label>
        <input type="date" id="date_fin" name="date_fin"/>
      </div>
      <div>
        <label for="superviseur">Superviseur :</label>
        <select id="superviseur" name="superviseur">
          <option value="">--Tous--</option>
          <option value="Vincent Lévesque">Vincent Lévesque</option>
          <option value="Olivier Chrétien">Olivier Chrétien</option>
        </select>
      </div>
      <div>
        <label for="quart">Quart :</label>
        <select id="quart" name="quart">
          <option value="">--Tous--</option>
          <option value="Jour">Jour</option>
          <option value="Nuit">Nuit</option>
        </select>
      </div>
      <div>
        <label for="categorie">Catégorie :</label>
        <select id="categorie" name="categorie">
          <option value="">--Toutes--</option>
          <option value="Digestion">Digestion</option>
          <option value="Cristalisation">Cristalisation</option>
          <option value="Centrifuge">Centrifuge</option>
          <option value="Décomposition (Harpers)">Décomposition (Harpers)</option>
          <option value="Calcination (F04)">Calcination (F04)</option>
          <option value="Lavage S02">Lavage S02</option>
          <option value="Buhler">Buhler</option>
          <option value="HP60 (Mega Pulse)">HP60 (Mega Pulse)</option>
          <option value="Mini-Pulse">Mini-Pulse</option>
          <option value="Fabrication de Puck">Fabrication de Puck</option>
          <option value="Traitement des eaux">Traitement des eaux</option>
          <option value="Commentaire générale">Commentaire générale</option>
        </select>
      </div>
      <div style="grid-column: span 2;">
        <label for="texte">Recherche texte :</label>
        <input type="text" id="texte" name="texte"/>
      </div>
      <div style="grid-column: span 2; text-align: right;">
        <button type="submit" style="padding: 0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border: none; border-radius: 4px; cursor: pointer;">Rechercher</button>
      </div>
    </form>
    <table id="resultsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Superviseur</th>
          <th>Catégorie</th>
          <th>Commentaires</th>
        </tr>
      </thead>
      <tbody>
        <tr class="no-results">
          <td colspan="4">Aucun résultat pour le moment.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Charger les rapports depuis localStorage
  var stored = localStorage.getItem('rapports');
  var rapports = stored ? JSON.parse(stored) : [];

  // Convertir la liste complète des rapports en entrées individuelles par catégorie
  function flattenReports(list) {
    var flat = [];
    list.forEach(function(r) {
      (r.categories || []).forEach(function(cat) {
        flat.push({
          date: r.date,
          superviseur: r.superviseur,
          quart: r.quart,
          categorie: cat.categorie,
          consigne: cat.consigne,
          commentaire: cat.commentaire,
          etat: cat.etat,
          resume: r.resume_jour,
          evt_sst: r.evt_sst,
          evt_env: r.evt_env,
          travaux_mec: r.travaux_mec
        });
      });
    });
    return flat;
  }

  // Fonction pour afficher les rapports dans le tableau
  function renderRows(items) {
    var tbody = document.querySelector('#resultsTable tbody');
    tbody.innerHTML = '';
    if (!items || items.length === 0) {
      var tr = document.createElement('tr');
      tr.className = 'no-results';
      var td = document.createElement('td');
      td.colSpan = 4;
      td.textContent = 'Aucun résultat pour le moment.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    items.forEach(function(it) {
      var tr = document.createElement('tr');
      var tdDate = document.createElement('td'); tdDate.textContent = it.date; tr.appendChild(tdDate);
      var tdSuper = document.createElement('td'); tdSuper.textContent = it.superviseur; tr.appendChild(tdSuper);
      var tdCat = document.createElement('td'); tdCat.textContent = it.categorie; tr.appendChild(tdCat);
      var tdComm = document.createElement('td'); tdComm.textContent = it.commentaire; tr.appendChild(tdComm);
      tbody.appendChild(tr);
    });
  }

  // Afficher toutes les entrées au chargement
  var flatReports = flattenReports(rapports);
  renderRows(flatReports);
        // Charger les rapports centralises
      fetchFromHub('ChangementQuart')
        .then(function(data) {
          data.forEach(function(row) {
            rapports.push({
              date:        row.date || '',
              superviseur: row.superviseur || '',
              quart:       row.quart || '',
              categories: [{
                categorie:   row.secteur || '',
                consigne:    row.action || '',
                commentaire: row.commentaire || '',
                etat:        row.statut || ''
              }],
              resume: '',
              resume_jour: '',
              evt_sst: '',
              evt_env: '',
              travaux_mec: ''
            });
          });
          flatReports = FlattenReports(rapports);
          renderRows(flatReports);
        })
        .catch(function(err) {
          console.error('Erreur lors du chargement des rapports centralises: ', err);
        });


  // Gérer la recherche
  var searchForm = document.getElementById('searchForm');
  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    var dateDebut = document.getElementById('date_debut').value;
    var dateFin = document.getElementById('date_fin').value;
    var superviseurSel = document.getElementById('superviseur').value;
    var quartSel = document.getElementById('quart').value;
    var categorieSel = document.getElementById('categorie').value;
    var texteSel = document.getElementById('texte').value.toLowerCase();
    var results = [];
    flatReports.forEach(function(it) {
      // Filtres sur la date
      if (dateDebut && it.date < dateDebut) return;
      if (dateFin && it.date > dateFin) return;
      // Superviseur
      if (superviseurSel && it.superviseur !== superviseurSel) return;
      // Quart
      if (quartSel && it.quart !== quartSel) return;
      // Catégorie
      if (categorieSel && it.categorie !== categorieSel) return;
      // Recherche texte (dans consigne, commentaire, état, résumé et autres champs)
      var searchSpace = (it.consigne + ' ' + it.commentaire + ' ' + it.etat + ' ' + it.resume + ' ' + it.evt_sst + ' ' + it.evt_env + ' ' + it.travaux_mec).toLowerCase();
      if (texteSel && searchSpace.indexOf(texteSel) === -1) return;
      results.push(it);
    });
    renderRows(results);
    <script>
  // Adapter la clé selon la page : 'ChangementQuart' / 'adminchangementquart' / 'adminkpi'
  const SHEET_KEY = 'ChangementQuart';
  fetch(`${ENDPOINT}?sheet=${encodeURIComponent(SHEET_KEY)}`)
    .then(resp => resp.json())
    .then(rows => {
      rows.forEach(row => {
        rapports.push({
          date:        row.date || '',
          superviseur: row.superviseur || '',
          quart:       row.quart || '',
          categories: [{
            categorie:   row.secteur || '',
            consigne:    row.action || '',
            commentaire: row.commentaire || '',
            etat:        row.statut || ''
          }],
          resume_jour: '',
          evt_sst:     '',
          evt_env:     '',
          travaux_mec: ''
        });
      });
      flatReports = flattenReports(rapports);
      renderRows(flatReports);
    })
    .catch(err => console.error('hub GET error:', err));
</script>
</body>
</html>
